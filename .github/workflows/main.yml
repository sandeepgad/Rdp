name: FASTEST RICH DESKTOP (SANDEEP EDITION)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 360

    steps:
      - name: 1. Install Cloudflared (Fastest)
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O /tmp/cloudflared
          chmod +x /tmp/cloudflared
          sudo mv /tmp/cloudflared /usr/local/bin/cloudflared

      - name: 2. Install Cinnamon Core (Rich & Lite)
        run: |
          sudo apt-get update
          # Installing Cinnamon Core (Fast & Rich)
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            cinnamon-core \
            xrdp dbus-x11 x11-xserver-utils \
            gnome-terminal
          
          # Fix for Polkit Directory Error
          sudo mkdir -p /etc/polkit-1/localauthority/50-local.d/
          
          # Fix Polkit Permissions
          echo "[Allow Colord all Users]
          Identity=unix-user:*
          Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
          ResultAny=no
          ResultInactive=no
          ResultActive=yes" | sudo tee /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla

          # Configure XRDP
          sudo adduser xrdp ssl-cert
          echo "cinnamon-session" > ~/.xsession
          sudo sed -i 's/3389/3389/g' /etc/xrdp/xrdp.ini
          sudo service xrdp start
          echo "âœ… Desktop Environment Ready"

      - name: 3. Install VS Code & Antigravity
        run: |
          # VS Code
          wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
          sudo install -D -o root -g root -m 644 packages.microsoft.gpg /etc/apt/keyrings/packages.microsoft.gpg
          echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" | sudo tee /etc/apt/sources.list.d/vscode.list > /dev/null
          
          # Chrome Download
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          
          # Install Both
          sudo apt-get update
          sudo apt-get install -y code ./google-chrome-stable_current_amd64.deb

          # Create Shortcuts
          mkdir -p ~/Desktop
          cat > ~/Desktop/Antigravity.desktop <<EOF
          [Desktop Entry]
          Version=1.0
          Name=Google Antigravity
          Exec=google-chrome --app=https://antigravity.google/ --no-sandbox
          Icon=google-chrome
          Type=Application
          EOF
          chmod +x ~/Desktop/Antigravity.desktop
          cp /usr/share/applications/code.desktop ~/Desktop/
          chmod +x ~/Desktop/code.desktop

      - name: 4. Create User (sandeepgaddam) & Start Tunnel
        run: |
          # Creating user 'sandeepgaddam'
          sudo useradd -m -s /bin/bash sandeepgaddam
          # Setting password to 'sandeep'
          echo "sandeepgaddam:sandeep" | sudo chpasswd
          sudo usermod -aG sudo sandeepgaddam
          
          # Start Tunnel
          /usr/local/bin/cloudflared tunnel --url tcp://localhost:3389 > tunnel.log 2>&1 &
          
          echo "Waiting for Link..."
          for i in {1..20}; do
            sleep 2
            TUN=$(grep -Eo 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' tunnel.log | head -1)
            if [ -n "$TUN" ]; then echo "ðŸŒ Tunnel: $TUN"; break; fi
          done
          echo "$TUN" > tunnel_url.txt

      - name: 5. CONNECT NOW
        run: |
          TUN=$(cat tunnel_url.txt)
          echo "==================================================="
          echo "   ðŸ”¥ SANDEEP DESKTOP READY ðŸ”¥"
          echo "==================================================="
          echo "ðŸ‘‡ RUN THIS COMMAND FIRST:"
          echo "cloudflared access tcp --hostname ${TUN#https://} --url localhost:3389"
          echo ""
          echo "ðŸ“² RD Client App Details:"
          echo "   PC Name : localhost:3389"
          echo "   User    : sandeepgaddam"
          echo "   Pass    : sandeep"
          echo "==================================================="

      - name: Keep Alive
        run: sleep 21600
